<html>
  <head>
    <link rel="stylesheet" href="//static.redsift.io/reusable/ui-rs-core/latest/css/ui-rs-core.min.css">
    <style>
      body {
        margin: 1em;
      }
    </style>    
  </head>
  <body>
    <h1>REFViewer in D3</h1>
    <p>Using the <code>d3-rs-bars</code> component, this <a href="http://www.staff.city.ac.uk/~jwo/refviewer/">re-implements the excellent REFViewer</a> by Jo Wood of the giCentre at City University, London.</p>
    <div id="elm"></div>
        
    <script src="https://d3js.org/d3.v4.0.0-alpha.49.js"></script>
    <script src="/d3-rs-bars.umd-es2015.min.js"></script>
    <script>
    'use strict';

    var FILLS = [ '#C8091A', '#DF3C47', '#F07679', '#FEADAA', '#FFE4DC' ];
    var LEGEND = [ '4*', '3*', '2*', '1*', 'u/c' ]; 
    var BAR_WIDTH = 545;
    var BAR_HEIGHT = 6;
    var BAR_PAD = 1;

    
    var chart = d3_rs_bars.html('refviewer')
                  .width(BAR_WIDTH)
                  .fill(FILLS)
                  .legend(LEGEND);
                  
    function draw(data) {
      chart.height(data.length * (BAR_HEIGHT + BAR_PAD));
      d3.select('#elm').datum(data).call(chart);      
    }
    
    
    // from: http://www.staff.city.ac.uk/~jwo/refviewer/data/RAE2008In2014Format.txt
    d3.tsv("/institutions.txt", function(raw) {
      var lookup = {};
      // create lookups table of display values
      raw.forEach(d => lookup[d['Institution name']] = d['Display']);

      d3.tsv("/RAE2008In2014Format.txt", function(raw) {
        var all = raw.map(d => ({ l: lookup[d['Institution name']], v: [ parseInt(d['4*']), parseInt(d['3*']), parseInt(d['2*']), parseInt(d['1*']), parseInt(d['unclassified']) ] }));
        console.log(all);
        draw(all);
      });
    });


    

    </script>
  </body>
</html>
